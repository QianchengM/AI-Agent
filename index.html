<!DOCTYPE html>
<html>

<head>
    <!-- é¡µé¢meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">




    <title>AI Agent On Chain</title>
    <meta name="description" content="AI Agent On Chain">
    <meta name="keywords" content="AI, Agent, Blockchain, Chain, Smart Contract, Decentralized, Web3, NFTs, Crypto, Digital Assets">




    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.6 -->
    <!-- Font Awesome -->
    <!-- Ionicons -->
    <!-- iCheck -->
    <!-- Morris chart -->
    <!-- jvectormap -->
    <!-- Date Picker -->
    <!-- Daterange picker -->
    <!-- Bootstrap time Picker -->
    <!--<link rel="stylesheet" href="./././plugins/timepicker/bootstrap-timepicker.min.css">-->
    <!-- bootstrap wysihtml5 - text editor -->
    <!--æ•°æ®è¡¨æ ¼-->
    <!-- è¡¨æ ¼æ ‘ -->
    <!-- select2 -->
    <!-- Bootstrap Color Picker -->
    <!-- bootstrap wysihtml5 - text editor -->
    <!--bootstrap-markdown-->
    <!-- Theme style -->
    <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
    <!-- Ion Slider -->
    <!-- ion slider Nice -->
    <!-- bootstrap slider -->
    <!-- bootstrap-datetimepicker -->

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->








    <!-- jQuery 2.2.3 -->
    <!-- jQuery UI 1.11.4 -->
    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <!-- Bootstrap 3.3.6 -->
    <!-- Morris.js charts -->
    <!-- Sparkline -->
    <!-- jvectormap -->
    <!-- jQuery Knob Chart -->
    <!-- daterangepicker -->
    <!-- datepicker -->
    <!-- Bootstrap WYSIHTML5 -->
    <!-- Slimscroll -->
    <!-- FastClick -->
    <!-- iCheck -->
    <!-- AdminLTE App -->
    <!-- è¡¨æ ¼æ ‘ -->
    <!-- select2 -->
    <!-- bootstrap color picker -->
    <!-- bootstrap time picker -->
    <!--<script src="./././plugins/timepicker/bootstrap-timepicker.min.js"></script>-->
    <!-- Bootstrap WYSIHTML5 -->
    <!--bootstrap-markdown-->
    <!-- CK Editor -->
    <!-- InputMask -->
    <!-- DataTables -->
    <!-- ChartJS 1.0.1 -->
    <!-- FLOT CHARTS -->
    <!-- FLOT RESIZE PLUGIN - allows the chart to redraw when the window is resized -->
    <!-- FLOT PIE PLUGIN - also used to draw donut charts -->
    <!-- FLOT CATEGORIES PLUGIN - Used to draw bar charts -->
    <!-- jQuery Knob -->
    <!-- Sparkline -->
    <!-- Morris.js charts -->
    <!-- Ion Slider -->
    <!-- Bootstrap slider -->
    <!-- bootstrap-datetimepicker -->
    <!-- é¡µé¢meta /-->

    <link rel="stylesheet" href="./plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="./plugins/ionicons/css/ionicons.min.css">
    <link rel="stylesheet" href="./plugins/iCheck/square/blue.css">
    <link rel="stylesheet" href="./plugins/morris/morris.css">
    <link rel="stylesheet" href="./plugins/jvectormap/jquery-jvectormap-1.2.2.css">
    <link rel="stylesheet" href="./plugins/datepicker/datepicker3.css">
    <link rel="stylesheet" href="./plugins/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" href="./plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css">
    <link rel="stylesheet" href="./plugins/datatables/dataTables.bootstrap.css">
    <link rel="stylesheet" href="./plugins/treeTable/jquery.treetable.css">
    <link rel="stylesheet" href="./plugins/treeTable/jquery.treetable.theme.default.css">
    <link rel="stylesheet" href="./plugins/select2/select2.css">
    <link rel="stylesheet" href="./plugins/colorpicker/bootstrap-colorpicker.min.css">
    <link rel="stylesheet" href="./plugins/bootstrap-markdown/css/bootstrap-markdown.min.css">
    <link rel="stylesheet" href="./plugins/adminLTE/css/AdminLTE.css">
    <link rel="stylesheet" href="./plugins/adminLTE/css/skins/_all-skins.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./plugins/ionslider/ion.rangeSlider.css">
    <link rel="stylesheet" href="./plugins/ionslider/ion.rangeSlider.skinNice.css">
    <link rel="stylesheet" href="./plugins/bootstrap-slider/slider.css">
    <link rel="stylesheet" href="./plugins/bootstrap-datetimepicker/bootstrap-datetimepicker.css">
</head>

<body class="hold-transition skin-purple sidebar-mini">

    <div class="wrapper">

        <!-- é¡µé¢å¤´éƒ¨ -->
        <header class="main-header">


            <!-- Logo -->
            <a href="index.html" class="logo">
                <!-- mini logo for sidebar mini 50x50 pixels -->
                <span class="logo-mini"><b>AI Agent</b></span>
                <!-- logo for regular state and mobile devices -->
                <span class="logo-lg"><b>AI Agent </b>onChain</span>
            </a>


            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top">
                <!-- Sidebar toggle button-->
                <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                    <span class="sr-only">Toggle navigation</span>
                </a>

                <div class="navbar-custom-menu">
                    <ul class="nav navbar-nav">
                        <!-- Messages: style can be found in dropdown.less-->
                        <li class="dropdown messages-menu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-envelope-o"></i>
                                <span class="label label-success"></span>
                            </a>
                        </li>
                        <!-- Notifications: style can be found in dropdown.less -->
                        <li class="dropdown notifications-menu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-bell-o"></i>
                                <span class="label label-warning"></span>
                            </a>
                        </li>
                        <!-- Tasks: style can be found in dropdown.less -->
                        <li class="dropdown tasks-menu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-flag-o"></i>
                                <span class="label label-danger"></span>
                            </a>
                        </li>
                        <!-- User Account: style can be found in dropdown.less -->
                        <li class="dropdown user user-menu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <img src="./img/metamask-fox.svg" class="user-image" alt="User Image">
                                <span class="hidden-xs">Metamask</span>
                            </a>
                            <ul class="dropdown-menu">
                                <!-- User image -->
                                <li class="user-header">
                                    <img src="./img/metamask-fox.svg" class="img-circle" alt="User Image">

                                    <p>
                                        Metamask
                                    </p>
                                </li>
                                <!-- Menu Body 
                        <li class="user-body">
                            <div class="row">
                                <div class="col-xs-4 text-center">
                                    <a href="#">Followers</a>
                                </div>
                                <div class="col-xs-4 text-center">
                                    <a href="#">Sales</a>
                                </div>
                                <div class="col-xs-4 text-center">
                                    <a href="#">Friends</a>
                                </div>
                            </div>
                        </li>-->
                                <!-- Menu Footer-->
                                <li class="user-footer">
                                    <div class="pull-right">
                                        <a href="#" class="btn btn-default btn-flat">EXIT</a>
                                    </div>
                                </li>
                            </ul>
                        </li>

                    </ul>
                </div>
            </nav>
        </header>
        <!-- é¡µé¢å¤´éƒ¨ /-->


        <!-- å¯¼èˆªä¾§æ  -->
        <aside class="main-sidebar">
            <!-- sidebar: style can be found in sidebar.less -->
            <section class="sidebar">
                <!-- Sidebar user panel -->
                <div class="user-panel">
                    <div class="pull-left image">
                        <img src="./img/metamask-fox.svg" class="img-circle" alt="User Image">
                    </div>
                    <div class="pull-left info">
                        <p>Metamask</p>
                        <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
                    </div>
                </div>
                <!-- search form -->
                <!--<form action="#" method="get" class="sidebar-form">
            <div class="input-group">
                <input type="text" name="q" class="form-control" placeholder="æœç´¢...">
                <span class="input-group-btn">
                <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i>
                </button>
              </span>
            </div>
        </form>-->
                <!-- /.search form -->


                <!-- sidebar menu: : style can be found in sidebar.less -->
                <ul class="sidebar-menu">
                    <li class="header">Menu</li>

                    <li id="admin-index"><a href="all-admin-index.html"><i class="fa fa-dashboard"></i> <span>Chat</span></a></li>

                    <!-- èœå• -->

                    <!-- èœå• /-->

                    <li id="admin-documentation"><a href="documentation.html" target="_blank"><i class="fa fa-book"></i> <span>Specification</span></a></li>

                </ul>
            </section>
            <!-- /.sidebar -->
        </aside>
        <!-- å¯¼èˆªä¾§æ  /-->


        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-wrapper">

            <div class="parent-container">
                <div class="chat-container">
                    <div class="chat-header">
                        <h3>Chat with AI</h3>
                    </div>
                    <div class="chat-messages">
                    
                    </div>
                    <div class="chat-input">
                        <textarea id="message-input" placeholder="Please enter your question..." autofocus></textarea>
                        <button id="send-button">Send</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- å†…å®¹åŒºåŸŸ /-->

        <!-- åº•éƒ¨å¯¼èˆª -->
        <footer class="main-footer">
            <div class="pull-right hidden-xs">
                <b>Version</b> 1.0.0
            </div>
            <strong>LLM:CHATGPT</strong>
        </footer>
        <!-- åº•éƒ¨å¯¼èˆª /-->

    </div>


    <script src="./plugins/jQuery/jquery-2.2.3.min.js"></script>
    <script src="./plugins/jQueryUI/jquery-ui.min.js"></script>
    <script>
        $.widget.bridge('uibutton', $.ui.button);
    </script>
    <script src="./plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="./plugins/raphael/raphael-min.js"></script>
    <script src="./plugins/morris/morris.min.js"></script>
    <script src="./plugins/sparkline/jquery.sparkline.min.js"></script>
    <script src="./plugins/jvectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="./plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <script src="./plugins/knob/jquery.knob.js"></script>
    <script src="./plugins/daterangepicker/moment.min.js"></script>
    <script src="./plugins/daterangepicker/daterangepicker.js"></script>
    <script src="./plugins/daterangepicker/daterangepicker.zh-CN.js"></script>
    <script src="./plugins/datepicker/bootstrap-datepicker.js"></script>
    <script src="./plugins/datepicker/locales/bootstrap-datepicker.zh-CN.js"></script>
    <script src="./plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.all.min.js"></script>
    <script src="./plugins/slimScroll/jquery.slimscroll.min.js"></script>
    <script src="./plugins/fastclick/fastclick.js"></script>
    <script src="./plugins/iCheck/icheck.min.js"></script>
    <script src="./plugins/adminLTE/js/app.min.js"></script>
    <script src="./plugins/treeTable/jquery.treetable.js"></script>
    <script src="./plugins/select2/select2.full.min.js"></script>
    <script src="./plugins/colorpicker/bootstrap-colorpicker.min.js"></script>
    <script src="./plugins/bootstrap-wysihtml5/bootstrap-wysihtml5.zh-CN.js"></script>
    <script src="./plugins/bootstrap-markdown/js/bootstrap-markdown.js"></script>
    <script src="./plugins/bootstrap-markdown/locale/bootstrap-markdown.zh.js"></script>
    <script src="./plugins/bootstrap-markdown/js/markdown.js"></script>
    <script src="./plugins/bootstrap-markdown/js/to-markdown.js"></script>
    <script src="./plugins/ckeditor/ckeditor.js"></script>
    <script src="./plugins/input-mask/jquery.inputmask.js"></script>
    <script src="./plugins/input-mask/jquery.inputmask.date.extensions.js"></script>
    <script src="./plugins/input-mask/jquery.inputmask.extensions.js"></script>
    <script src="./plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="./plugins/datatables/dataTables.bootstrap.min.js"></script>
    <script src="./plugins/chartjs/Chart.min.js"></script>
    <script src="./plugins/flot/jquery.flot.min.js"></script>
    <script src="./plugins/flot/jquery.flot.resize.min.js"></script>
    <script src="./plugins/flot/jquery.flot.pie.min.js"></script>
    <script src="./plugins/flot/jquery.flot.categories.min.js"></script>
    <script src="./plugins/ionslider/ion.rangeSlider.min.js"></script>
    <script src="./plugins/bootstrap-slider/bootstrap-slider.js"></script>
    <script src="./plugins/bootstrap-datetimepicker/bootstrap-datetimepicker.js"></script>
    <script src="./plugins/bootstrap-datetimepicker/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    
    <script>
        $(document).ready(function() {
            // é€‰æ‹©æ¡†
            $(".select2").select2();

            // WYSIHTML5ç¼–è¾‘å™¨
            $(".textarea").wysihtml5({
                locale: 'zh-CN'
            });
        });


        // è®¾ç½®æ¿€æ´»èœå•
        function setSidebarActive(tagUri) {
            var liObj = $("#" + tagUri);
            if (liObj.length > 0) {
                liObj.parent().parent().addClass("active");
                liObj.addClass("active");
            }
        }


        $(document).ready(function() {
            // æ¿€æ´»å¯¼èˆªä½ç½®
            setSidebarActive("admin-index");
        });
    </script>

 <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>

    <script>
        // DOMå…ƒç´ 
        const chatMessages = document.querySelector('.chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let conversationHistory = [];

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            addMessageToUI('Hello! æˆ‘æ˜¯ä½ çš„ DeFi æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ æŸ¥ä½™é¢ã€æŸ¥å¸ä»·ï¼Œæˆ–è€…æŠŠé’±å­˜å…¥ Aaveã€‚', 'ai');
        });

        // äº‹ä»¶ç›‘å¬
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // --- æ ¸å¿ƒå‘é€é€»è¾‘ ---
       // --- æ ¸å¿ƒå‘é€é€»è¾‘ (ä¿®å¤ç‰ˆ) ---
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;

            // 1. å…ˆæ¸…ç©ºè¾“å…¥æ¡†å¹¶ä¸Šå±ç”¨æˆ·æ¶ˆæ¯
            messageInput.value = '';
            addMessageToUI(messageText, 'user');
            conversationHistory.push({ role: 'user', content: messageText });

            const loadingId = addLoadingToUI();
            sendButton.disabled = true;

            try {
                const response = await fetch('http://localhost:8000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: conversationHistory })
                });

                const data = await response.json();
                removeLoadingUI(loadingId);

                let aiRawText = data.answer;
                let displayText = aiRawText;
                let txPayload = null;

                // --- ğŸ”„ å…³é”®ä¿®å¤ï¼šä¼˜åŒ– JSON æå–é¡ºåºä¸é€»è¾‘ ---
                // ä¸ä½¿ç”¨æ­£åˆ™ matchï¼Œè€Œæ˜¯é€šè¿‡æŸ¥æ‰¾ç¬¬ä¸€ä¸ª '{' å’Œæœ€åä¸€ä¸ª '}' æ¥å®šä½ JSON
                // è¿™æ ·èƒ½é¿å…æ­£åˆ™åŒ¹é…åˆ°é”™è¯¯çš„å­—ç¬¦é¡ºåº
                const startIdx = aiRawText.indexOf('{');
                const endIdx = aiRawText.lastIndexOf('}');

                if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {
                    try {
                        const potentialJson = aiRawText.substring(startIdx, endIdx + 1);
                        const parsed = JSON.parse(potentialJson);
                        
                        // åªæœ‰æ˜ç¡®æ ‡è®°ä¸º transaction ç±»å‹æ—¶æ‰æå–äº¤æ˜“æ•°æ®
                        if (parsed.type === "transaction") {
                            displayText = parsed.message; // æå–å¹²å‡€çš„æç¤ºæ–‡æœ¬
                            txPayload = parsed.tx_data;   // æå–äº¤æ˜“è´Ÿè½½
                            console.log("âœ… æˆåŠŸè§£æäº¤æ˜“æ•°æ®:", txPayload);
                        }
                    } catch (e) {
                        console.warn("JSON è§£æè·³è¿‡ (å†…å®¹åŒ…å«æ‹¬å·ä½†ä¸æ˜¯æœ‰æ•ˆJSON):", e);
                    }
                }

                // 2. å…ˆæ›´æ–° UI æ˜¾ç¤º AI çš„å›å¤ (è¿™ä¸€æ­¥å¿…é¡»åœ¨å”¤èµ·é’±åŒ…ä¹‹å‰!)
                // è¿™æ ·ç”¨æˆ·èƒ½å…ˆçœ‹åˆ° "å·²ä¸ºæ‚¨å‡†å¤‡å¥½å­˜å…¥ 0.1 ETH..." çš„æç¤º
                addMessageToUI(displayText, 'ai');
                conversationHistory.push({ role: 'assistant', content: aiRawText });

                // 3. æœ€åå†è§¦å‘é’±åŒ… (é˜²æ­¢é’±åŒ…å¼¹çª—é˜»å¡ UI æ¸²æŸ“)
                if (txPayload) {
                    console.log("ğŸš€ æ­£åœ¨å”¤èµ· MetaMask...");
                    // ç­‰å¾… UI æ¸²æŸ“å¾®å°å»¶è¿Ÿï¼Œç¡®ä¿ç•Œé¢æµç•…
                    setTimeout(async () => {
                        await triggerMetaMask(txPayload);
                    }, 100);
                }

            } catch (error) {
                removeLoadingUI(loadingId);
                addMessageToUI(`âŒ ç³»ç»Ÿå‡ºé”™: ${error.message}`, 'ai');
                console.error(error);
            } finally {
                sendButton.disabled = false;
                scrollToBottom();
            }
        }

        // --- é’±åŒ…äº¤äº’ ---
       // --- é’±åŒ…äº¤äº’ (å¢å¼ºç‰ˆï¼šè‡ªåŠ¨åˆ‡ç½‘) ---
        async function triggerMetaMask(txData) {
            if (typeof window.ethereum === 'undefined') {
                alert("è¯·å…ˆå®‰è£… MetaMask æ’ä»¶!");
                return;
            }
            
            try {
                // 1. è¯·æ±‚è´¦æˆ·
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // 2. ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘ (ChainID: 0xaa36a7)
                const sepoliaChainId = '0xaa36a7'; // 11155111 çš„åå…­è¿›åˆ¶
                
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: sepoliaChainId }],
                    });
                } catch (switchError) {
                    // å¦‚æœç”¨æˆ·æ²¡æ·»åŠ è¿‡ Sepoliaï¼Œè¿™é‡Œé€šè¿‡ä»£ç å¸®ä»–æ·»åŠ  (æå°‘è§ï¼ŒMetaMask è‡ªå¸¦ Sepolia)
                    if (switchError.code === 4902) {
                        alert("è¯·åœ¨ MetaMask è®¾ç½®ä¸­å¼€å¯ 'æ˜¾ç¤ºæµ‹è¯•ç½‘ç»œ' å¹¶æ‰‹åŠ¨åˆ‡æ¢åˆ° Sepoliaã€‚");
                        return;
                    } else {
                        throw switchError;
                    }
                }

                addMessageToUI(`ğŸ¦Š ç½‘ç»œæ­£ç¡®ï¼æ­£åœ¨å”¤èµ· MetaMask...`, 'system');
                
                // 3. å‘é€äº¤æ˜“
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: accounts[0],
                        to: txData.to,
                        data: txData.data,
                        value: txData.value || '0x0' 
                    }],
                });
                
                addMessageToUI(`âœ… äº¤æ˜“å·²å‘é€ï¼\nHash: ${txHash}`, 'ai');

            } catch (error) {
                console.error(error);
                // ä¼˜åŒ–é”™è¯¯æç¤º
                let msg = error.message;
                if (error.code === 4001) msg = "ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ";
                if (msg.includes("User rejected")) msg = "ç”¨æˆ·æ‹’ç»äº†ç­¾å";
                addMessageToUI(`âš ï¸ äº¤æ˜“å–æ¶ˆ: ${msg}`, 'ai');
            }
        }

        // --- UI æ¸²æŸ“ (å¼ºåˆ¶ Flex å¸ƒå±€ç‰ˆ) ---
        function addMessageToUI(text, sender) {
            const rowDiv = document.createElement('div');
            const now = new Date();
            const timeString = now.getHours() + ':' + (now.getMinutes()<10?'0':'') + now.getMinutes();

            // å¼ºåˆ¶æ ·å¼ï¼šFlexå¸ƒå±€
            rowDiv.style.display = 'flex';
            rowDiv.style.marginBottom = '15px';
            rowDiv.style.alignItems = 'flex-start';

            let html = '';
            
            if (sender === 'user') {
                // ç”¨æˆ·åœ¨å³è¾¹
                rowDiv.style.justifyContent = 'flex-end';
                html = `
                    <div style="max-width: 70%; margin-right: 10px;">
                        <div style="font-size: 12px; color: #999; text-align: right; margin-bottom: 4px;">User ${timeString}</div>
                        <div style="background-color: #007bff; color: white; padding: 10px 15px; border-radius: 15px 0 15px 15px; position: relative;">
                            ${text}
                        </div>
                    </div>
                    <img src="./img/avatar5.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4140/4140048.png'" style="width: 40px; height: 40px; border-radius: 50%;">
                `;
            } else {
                // AI åœ¨å·¦è¾¹
                rowDiv.style.justifyContent = 'flex-start';
                html = `
                    <img src="./img/avatar.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712027.png'" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                    <div style="max-width: 70%;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">AI Agent ${timeString}</div>
                        <div style="background-color: #f4f6f9; color: #333; padding: 10px 15px; border-radius: 0 15px 15px 15px; border: 1px solid #ddd;">
                            ${text}
                        </div>
                    </div>
                `;
            }

            rowDiv.innerHTML = html;
            chatMessages.appendChild(rowDiv);
            scrollToBottom();
        }

        function addLoadingToUI() {
            const id = 'loading-' + Date.now();
            const rowDiv = document.createElement('div');
            rowDiv.id = id;
            rowDiv.style.display = 'flex';
            rowDiv.style.justifyContent = 'flex-start';
            rowDiv.style.marginBottom = '15px';
            
            rowDiv.innerHTML = `
                <img src="./img/avatar.png" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                <div style="background-color: #f4f6f9; padding: 10px 15px; border-radius: 0 15px 15px 15px; color: #666;">
                    <i class="fa fa-spinner fa-spin"></i> Thinking...
                </div>
            `;
            chatMessages.appendChild(rowDiv);
            scrollToBottom();
            return id;
        }

        function removeLoadingUI(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>

</html>
<!---->